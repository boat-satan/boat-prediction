name: Fetch Results (range day)

on:
  workflow_dispatch:
    inputs:
      date:
        description: "対象日 (YYYYMMDD)"
        required: true
        default: "20250812"
      pids_csv:
        description: "場コードCSV (例: 01,02,03,...,24)"
        required: false
        default: "01,02,03,04,05,06,07,08,09,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24"
      races_csv:
        description: "レース番号CSV (例: 1,2,...,12)"
        required: false
        default: "1,2,3,4,5,6,7,8,9,10,11,12"
      parallel:
        description: "最大並列数 (jobs.strategy.max-parallel)"
        required: false
        default: "24"
      skip_existing:
        description: "既存JSONがあればスキップ"
        required: false
        default: "true"
      fetch_delay_ms:
        description: "アクセス間隔(ms)"
        required: false
        default: "1200"

permissions:
  contents: write

jobs:
  build-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}
    steps:
      - id: mk
        run: |
          PIDS='[${{ inputs.pids_csv }}]'
          PIDS=$(echo "$PIDS" | sed 's/,/","/g; s/\[/\["/; s/\]/"\]/')
          RACES='[${{ inputs.races_csv }}]'
          RACES=$(echo "$RACES" | sed 's/,/","/g; s/\[/\["/; s/\]/"\]/')
          echo "matrix={\"pid\":$PIDS,\"race\":$RACES}" >> $GITHUB_OUTPUT

  run:
    needs: build-matrix
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: ${{ fromJson(inputs.parallel) }}
      matrix:
        pid: ${{ fromJson(needs.build-matrix.outputs.matrix).pid }}
        race: ${{ fromJson(needs.build-matrix.outputs.matrix).race }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm ci --no-audit --no-fund
          else
            npm init -y
            npm pkg set type="module"
            npm i cheerio@1
          fi

      - name: Fetch result
        env:
          SKIP_EXISTING: ${{ inputs.skip_existing }}
          FETCH_DELAY_MS: ${{ inputs.fetch_delay_ms }}
        run: |
          node scripts/fetch-result-official.js \
            "${{ inputs.date }}" "${{ matrix.pid }}" "${{ matrix.race }}"

      - name: Commit & push (batch-safe)
        if: ${{ matrix.pid == fromJson(needs.build-matrix.outputs.matrix).pid[0] && matrix.race == fromJson(needs.build-matrix.outputs.matrix).race[0] }}
        run: |
          set -e
          git config user.name  github-actions
          git config user.email github-actions@users.noreply.github.com
          git add -A
          if git diff --cached --quiet; then
            echo "No changes"
            exit 0
          fi
          git commit -m "add: results ${{ inputs.date }} (batch)"
          # リモート更新に備えてrebaseしてからpush（衝突時は再試行）
          for i in 1 2 3; do
            set +e
            git pull --rebase
            rc=$?
            set -e
            if [ $rc -eq 0 ]; then
              git push && break
            fi
            echo "retry $i..."
            sleep 2
          done
