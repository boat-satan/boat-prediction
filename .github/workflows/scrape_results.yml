name: fetch-results

on:
  workflow_dispatch:
    inputs:
      date:
        description: "ÈñãÂÇ¨Êó• (YYYYMMDD)"
        required: true
        type: string
      pids:
        description: "Â†¥„Ç≥„Éº„ÉâÔºà01,02,‚Ä¶ or 'all'Ôºâ"
        required: false
        default: "all"
        type: string
      races:
        description: "„É¨„Éº„ÇπÁï™Âè∑Ôºà1,2,‚Ä¶ or 'all'Ôºâ"
        required: false
        default: "all"
        type: string
      skip_existing:
        description: "Êó¢Â≠ò„Éï„Ç°„Ç§„É´„Çí„Çπ„Ç≠„ÉÉ„Éó"
        required: false
        default: "true"
        type: choice
        options: ["true","false"]

concurrency:
  group: fetch-results-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    env:
      DATE: ${{ inputs.date }}
      PIDS_INPUT: ${{ inputs.pids }}
      RACES_INPUT: ${{ inputs.races }}
      SKIP_EXISTING: ${{ inputs.skip_existing }}
      SCRIPT_PATH: scripts/fetch-result-official.js

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps (cheerio)
        run: |
          npm init -y >/dev/null 2>&1 || true
          npm i cheerio@^1 --no-audit --no-fund

      - name: Verify script exists
        run: |
          test -f "$SCRIPT_PATH" || { echo "Not found: $SCRIPT_PATH"; exit 1; }
          node -v
          node -e "console.log('cheerio', require('cheerio/package.json').version)"

      - name: Build PID / RACE lists
        id: build_lists
        shell: bash
        run: |
          # === PIDS ===
          if [ "$PIDS_INPUT" = "all" ] || [ -z "$PIDS_INPUT" ]; then
            PIDS=$(printf "%02d," $(seq 1 24) | sed 's/,$//')
          else
            PIDS=$(echo "$PIDS_INPUT" | tr ' ' ',' | sed 's/,,*/,/g' | sed 's/^,\|,$//g')
            # ÂêÑË¶ÅÁ¥†„Çí2Ê°ÅÂåñ
            TMP=""
            IFS=',' read -ra ARR <<< "$PIDS"
            for x in "${ARR[@]}"; do
              n=$(printf "%02d" $((10#$x)))
              TMP="${TMP}${n},"
            done
            PIDS="${TMP%,}"
          fi

          # === RACES ===
          if [ "$RACES_INPUT" = "all" ] || [ -z "$RACES_INPUT" ]; then
            RACES=$(seq -s, 1 12)
          else
            RACES=$(echo "$RACES_INPUT" | tr ' ' ',' | sed 's/,,*/,/g' | sed 's/^,\|,$//g')
          fi

          echo "PIDS: $PIDS"
          echo "RACES: $RACES"

          # üëá GITHUB_OUTPUT „ÅØ1Ë°å„ÅßÊ∏°„ÅôÔºàÊîπË°åNGÔºâ
          {
            echo "pids=${PIDS}"
            echo "races=${RACES}"
            echo "date=${DATE}"
            echo "skip=${SKIP_EXISTING}"
          } >> "$GITHUB_OUTPUT"

      - name: Fetch results
        shell: bash
        env:
          SKIP_EXISTING: ${{ steps.build_lists.outputs.skip }}
        run: |
          set -e
          DATE="${{ steps.build_lists.outputs.date }}"
          PIDS="${{ steps.build_lists.outputs.pids }}"
          RACES="${{ steps.build_lists.outputs.races }}"

          echo "Running DATE=$DATE"
          mkdir -p data/results

          for PID in $(echo "$PIDS" | tr ',' ' '); do
            for R in $(echo "$RACES" | tr ',' ' '); do
              echo "::group::Fetch jcd=${PID} rno=${R}"
              node "$SCRIPT_PATH" "$DATE" "$PID" "$R" || echo "[warn] failed: $DATE $PID $R"
              echo "::endgroup::"
              sleep 1
            done
          done

      - name: Show tree
        run: |
          echo "==== output tree ===="
          if command -v tree >/dev/null 2>&1; then
            tree -a data/results || true
          else
            find data/results -type f | sort || true
          fi

      - name: Upload artifact (data/results)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ inputs.date }}
          path: data/results
          if-no-files-found: ignore
