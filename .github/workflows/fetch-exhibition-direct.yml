name: Fetch Exhibition (beforeinfo)

on:
  workflow_dispatch:
    inputs:
      date:
        description: "対象日 (YYYYMMDD)"
        required: true
        default: "20250101"
      mode:
        description: "single: 単発 / all: 24場一括（並列）"
        required: true
        default: "single"
        type: choice
        options: [single, all]
      pid:
        description: "01..24（single時のみ）"
        required: false
        default: "01"
      race:
        description: "1R|1..12|1,3,5R...|auto（auto=締切N分前で自動）"
        required: true
        default: "auto"
      parallel:
        description: "同時実行数（all時のみ）"
        required: false
        default: "6"

permissions:
  contents: write

env:
  # fetch-exhibition-direct.js で読む環境変数（必要に応じて調整）
  TIMEOUT_MS: "10000"
  RETRIES: "3"
  COOLDOWN_MS: "200"
  AUTO_TRIGGER_MIN: "15"
  UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126 Safari/537.36"

jobs:
  single:
    if: ${{ inputs.mode == 'single' }}
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-single-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci --ignore-scripts
          else
            npm i --no-audit --no-fund
          fi

      - name: Fetch exhibition (single)
        env:
          TARGET_DATE:  ${{ inputs.date }}
          TARGET_PIDS:  ${{ inputs.pid }}
          TARGET_RACES: ${{ inputs.race }}
        run: |
          set -e
          node scripts/fetch-exhibition-direct.js "$TARGET_DATE" "$TARGET_PIDS" "$TARGET_RACES" --skip-existing || \
          node scripts/fetch-exhibition-direct.js "$TARGET_DATE" "$TARGET_PIDS" "$TARGET_RACES"

      - name: Commit & Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          # 先にコミット（重要）
          git commit -m "chore: fetch exhibition beforeinfo ${{
            inputs.date
          }} pid=${{ inputs.pid }} race='${{ inputs.race }}'"

          # 自動stash付きでrebase pull
          git -c rebase.autoStash=true pull --rebase || true

          # リトライ付き push（並列衝突対策）
          for i in 1 2 3 4 5; do
            if git push; then
              exit 0
            fi
            echo "Push failed, retrying ($i/5)..."
            git -c rebase.autoStash=true pull --rebase || true
            sleep $((i*2))
          done
          echo "Push failed after retries." >&2
          exit 1

  all:
    if: ${{ inputs.mode == 'all' }}
    runs-on: ubuntu-latest
    strategy:
      max-parallel: ${{ fromJSON(inputs.parallel || '6') }}
      fail-fast: false
      matrix:
        pid: ['01','02','03','04','05','06','07','08','09','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24']
    concurrency:
      group: ${{ github.workflow }}-all-${{ matrix.pid }}-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci --ignore-scripts
          else
            npm i --no-audit --no-fund
          fi

      - name: Fetch exhibition (pid=${{ matrix.pid }})
        env:
          TARGET_DATE:  ${{ inputs.date }}
          TARGET_PIDS:  ${{ matrix.pid }}
          TARGET_RACES: ${{ inputs.race }}
        run: |
          set -e
          node scripts/fetch-exhibition-direct.js "$TARGET_DATE" "$TARGET_PIDS" "$TARGET_RACES" --skip-existing || \
          node scripts/fetch-exhibition-direct.js "$TARGET_DATE" "$TARGET_PIDS" "$TARGET_RACES"

      - name: Commit & Push (sharded)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit for pid ${{ matrix.pid }}."
            exit 0
          fi

          git commit -m "chore: fetch exhibition beforeinfo ${{ inputs.date }} pid=${{ matrix.pid }} race='${{ inputs.race }}'"

          git -c rebase.autoStash=true pull --rebase || true

          for i in 1 2 3 4 5; do
            if git push; then
              exit 0
            fi
            echo "Push failed, retrying ($i/5)..."
            git -c rebase.autoStash=true pull --rebase || true
            sleep $((i*2))
          done
          echo "Push failed after retries." >&2
          exit 1
