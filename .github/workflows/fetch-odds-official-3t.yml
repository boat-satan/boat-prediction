name: Fetch 3T Odds (range simple, robust push w/ lease)

on:
  workflow_dispatch:
    inputs:
      scope:
        description: "取得範囲: day / month / year"
        required: true
        default: "month"
      date:
        description: "scope=day のみ (YYYYMMDD)"
        required: false
        default: "20250101"
      year:
        description: "scope=month/year で使用 (YYYY)"
        required: false
        default: "2025"
      month:
        description: "scope=month で使用 (1..12)"
        required: false
        default: "1"
      parallel:
        description: "並列数 (xargs -P)"
        required: false
        default: "72"

permissions:
  contents: write

# 同一ブランチは常に1本だけ実行
concurrency:
  group: odds3t-${{ github.repository }}-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install deps
        run: |
          set -euo pipefail
          if [ -f package.json ]; then
            npm ci --no-audit --no-fund || npm i --no-audit --no-fund
          else
            npm init -y
            npm pkg set type=module
            npm i cheerio@^1.0.0-rc.12 --no-audit --no-fund
          fi

      - name: Build date list (bash only)
        env:
          SCOPE:   ${{ github.event.inputs.scope }}
          DATE:    ${{ github.event.inputs.date }}
          YEAR:    ${{ github.event.inputs.year }}
          MONTH:   ${{ github.event.inputs.month }}
        run: |
          set -euo pipefail
          : > dates.txt
          if [ "$SCOPE" = "day" ]; then
            echo "$DATE" > dates.txt
          elif [ "$SCOPE" = "month" ]; then
            y="$YEAR"
            m="$(printf '%02d' "$MONTH")"
            start="${y}-${m}-01"
            end="$(date -d "${start} +1 month" +%Y-%m-%d)"
            d="$start"
            while [ "$(date -d "$d" +%Y-%m-%d)" != "$end" ]; do
              date -d "$d" +%Y%m%d
              d="$(date -d "$d +1 day" +%Y-%m-%d)"
            done > dates.txt
          elif [ "$SCOPE" = "year" ]; then
            y="$YEAR"
            start="${y}-01-01"
            end="$((y+1))-01-01"
            d="$start"
            while [ "$(date -d "$d" +%Y-%m-%d)" != "$end" ]; do
              date -d "$d" +%Y%m%d
              d="$(date -d "$d +1 day" +%Y-%m-%d)"
            done > dates.txt
          else
            echo "invalid scope=$SCOPE (use: day|month|year)"; exit 1
          fi
          echo "dates count: $(wc -l < dates.txt)"

      - name: Fetch all odds (one pass, no retry)
        env:
          PARALLEL: ${{ github.event.inputs.parallel }}
        run: |
          set -euo pipefail
          echo "Parallel jobs: ${PARALLEL:-72}"
          { while read -r dt; do
              for p in $(printf "%02d\n" $(seq 1 24)); do
                for r in $(seq 1 12); do
                  printf "%s %s %s\n" "$dt" "$p" "$r"
                done
              done
            done < dates.txt; } \
          | xargs -P "${PARALLEL:-72}" -n 3 sh -c '
              dt="$1"; pid="$2"; race="$3";
              echo "=== Fetch $dt $pid $race ===";
              node scripts/fetch-odds-official-3t.js "$dt" "$pid" "$race" || true
            ' _

      - name: Commit & push (rebase with fallback force-with-lease)
        env:
          SCOPE: ${{ github.event.inputs.scope }}
          DATE:  ${{ github.event.inputs.date }}
          YEAR:  ${{ github.event.inputs.year }}
          MONTH: ${{ github.event.inputs.month }}
          PAR:   ${{ github.event.inputs.parallel }}
        run: |
          set -euo pipefail

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          case "$SCOPE" in
            day)   MSG="odds3t: day=${DATE} (parallel=${PAR})" ;;
            month) MSG="odds3t: month=${YEAR}-$(printf '%02d' "$MONTH") (parallel=${PAR})" ;;
            year)  MSG="odds3t: year=${YEAR} (parallel=${PAR})" ;;
            *)     MSG="odds3t: batch (parallel=${PAR})" ;;
          esac

          BR="$(git rev-parse --abbrev-ref HEAD)"
          git add -A
          git commit -m "$MSG" || true

          # まずは正攻法: fetch->rebase->push を最大10回
          tries=0
          until [ $tries -ge 10 ]
          do
            git fetch origin "$BR" --prune
            git rebase "origin/$BR" || true
            if git push origin "$BR"; then
              echo "push success (regular)"
              exit 0
            fi
            tries=$((tries+1))
            echo "push retry $tries/10 (backoff)"
            sleep $((2 * tries))
          done

          echo "regular push failed after 10 tries. evaluating safe force-with-lease..."

          # 変更が public/odds/v1/ 配下の生成物だけかチェック
          CHANGED_PATHS="$(git diff --name-only "origin/$BR"...HEAD || true)"
          echo "changed paths since remote:"
          echo "$CHANGED_PATHS"

          if [ -z "$CHANGED_PATHS" ]; then
            echo "No diff vs remote; nothing to push?"
            exit 0
          fi

          # 生成物以外の変更が混ざっていたら安全のため中断
          if echo "$CHANGED_PATHS" | grep -v '^public/odds/v1/' >/dev/null 2>&1; then
            echo "::error::Detected changes outside public/odds/v1/. Aborting force push for safety."
            exit 1
          fi

          # 生成物のみ → lease 付き強制 push
          if git push --force-with-lease origin "$BR"; then
            echo "push success (force-with-lease for artifacts)"
          else
            echo "::error::force-with-lease push failed"
            exit 1
          fi
