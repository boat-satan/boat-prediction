name: fetch-odds3t

on:
  workflow_dispatch:
    inputs:
      date:
        description: "YYYYMMDD"
        required: true
        default: "20250101"
      mode:
        description: "single or all"
        required: true
        default: "single"
      pid:
        description: "01..24 (single only)"
        required: false
        default: "01"
      race:
        description: "1..12 (single only)"
        required: false
        default: "1"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Fetch odds
        env:
          DATE: ${{ github.event.inputs.date }}
          MODE: ${{ github.event.inputs.mode }}
          PID:  ${{ github.event.inputs.pid }}
          RACE: ${{ github.event.inputs.race }}
        run: |
          set -euo pipefail
          echo "MODE=$MODE DATE=$DATE PID=$PID RACE=$RACE"
          if [ "$MODE" = "all" ]; then
            for pid in $(printf "%02d\n" $(seq 1 24)); do
              for race in $(seq 1 12); do
                echo "fetch $DATE $pid $race"
                node scripts/fetch-odds-official-3t.js "$DATE" "$pid" "$race" || true
                sleep 1
              done
            done
          else
            node scripts/fetch-odds-official-3t.js "$DATE" "$PID" "$RACE"
          fi

      - name: Commit and push
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "odds3t: ${{ github.event.inputs.date }} ${{ github.event.inputs.mode }}"
            git push
          else
            echo "No changes."
          fi
