name: Fetch 3T Odds (official)

on:
  workflow_dispatch:
    inputs:
      mode:
        description: "single=指定のみ / all=全場×全R"
        required: true
        default: "single"
      date:
        description: "対象日 (YYYYMMDD)"
        required: true
      pid:
        description: "場コード 01..24（single時のみ使用）"
        required: false
      race:
        description: "レース番号 1..12（single時のみ使用）"
        required: false

permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Show inputs
        run: |
          echo "mode=${{ github.event.inputs.mode }}"
          echo "date=${{ github.event.inputs.date }}"
          echo "pid=${{ github.event.inputs.pid }}"
          echo "race=${{ github.event.inputs.race }}"

      - name: Run (single)
        if: ${{ github.event.inputs.mode == 'single' }}
        env:
          TARGET_DATE: ${{ github.event.inputs.date }}
          TARGET_PID:  ${{ github.event.inputs.pid }}
          TARGET_RACE: ${{ github.event.inputs.race }}
          SKIP_EXISTING: "1"
        run: |
          set -euo pipefail
          node scripts/fetch-odds-official-3t.js "${TARGET_DATE}" "${TARGET_PID}" "${TARGET_RACE}"

      - name: Run (all: 全場×全R)
        if: ${{ github.event.inputs.mode == 'all' }}
        env:
          TARGET_DATE: ${{ github.event.inputs.date }}
          SKIP_EXISTING: "1"
        run: |
          set -euo pipefail
          date="${TARGET_DATE}"
          for pid in $(printf "%02d\n" $(seq 1 24)); do
            for race in $(seq 1 12); do
              echo "=== FETCH ${date} pid=${pid} race=${race} ==="
              node scripts/fetch-odds-official-3t.js "${date}" "${pid}" "${race}" || true
              sleep 1
            done
          done

      - name: Set git identity
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit & Push if changed
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            MODE="${{ github.event.inputs.mode }}"
            DATE="${{ github.event.inputs.date }}"
            PID="${{ github.event.inputs.pid }}"
            RACE="${{ github.event.inputs.race }}"
            if [ "$MODE" = "single" ]; then
              MSG="odds3t: date=${DATE} pid=${PID} race=${RACE}"
            else
              MSG="odds3t: date=${DATE} (all pids & races)"
            fi
            git add -A
            git commit -m "$MSG"
            git push
          else
            echo "No changes to commit."
          fi
