name: Build Staging (from integrated_pro)

on:
  workflow_dispatch:
    inputs:
      scope:
        description: "処理対象: day or all"
        required: true
        default: "day"
        type: choice
        options: [day, all]
      date:
        description: "scope=day のみ (YYYYMMDD)"
        required: false
        default: "20240101"
      csv_compress:
        description: "staging CSVをgzip圧縮する？ (true/false)"
        required: true
        default: "false"

concurrency:
  group: build-staging-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install polars pandas pyyaml

      - name: Build staging
        shell: bash
        run: |
          set -euo pipefail

          SCOPE="${{ inputs.scope }}"
          DATE="${{ inputs.date }}"
          IN_ROOT="data/shards"
          OUT_ROOT="data/staging"

          mkdir -p "${OUT_ROOT}"

          if [[ "$SCOPE" == "day" ]]; then
            [[ "$DATE" =~ ^[0-9]{8}$ ]] || { echo "DATE must be YYYYMMDD when scope=day" >&2; exit 1; }
            YEAR="${DATE:0:4}"
            MD="${DATE:4:4}"
            IN_DIR="${IN_ROOT}/${YEAR}/${MD}"
            OUT_DIR="${OUT_ROOT}/${YEAR}/${MD}"
          else
            IN_DIR="${IN_ROOT}"
            OUT_DIR="${OUT_ROOT}"
          fi

          [[ -d "$IN_DIR" ]] || { echo "[FATAL] Input directory not found: $IN_DIR" >&2; exit 1; }

          PY="scripts/build_staging_from_integrated.py"
          [[ -f "$PY" ]] || { echo "[FATAL] $PY が見つかりません。リポジトリに追加してください。" >&2; exit 1; }

          ARGS=(--in_root "$IN_DIR" --out_root "$OUT_DIR")
          if [[ "${{ inputs.csv_compress }}" == "true" ]]; then
            ARGS+=("--csv_compress")
          fi

          echo "[run] python $PY ${ARGS[*]}"
          python "$PY" "${ARGS[@]}"

      - name: Show outputs
        run: |
          echo "---- data/staging (tree) ----"
          ls -lahR data/staging || true

      - name: Commit & push staging outputs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -f data/staging || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "staging: build from data/shards (${{ inputs.scope }} ${{ inputs.date }}) [skip ci]"
          # 競合回避のため軽くリトライ
          for n in 0 1 2 3 4; do
            if git pull --rebase; then
              git push && exit 0
            fi
            echo "Pull failed. Retry $((n+1))/5..."
            sleep $((2**n))
          done
          # 最後にもう一度だけpush試行
          git push
