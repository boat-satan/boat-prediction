name: Build Staging (from integrated_pro)

on:
  workflow_dispatch:
    inputs:
      scope:
        description: "処理対象: day or all"
        required: true
        default: "day"
        type: choice
        options: [day, all]
      date:
        description: "scope=day のみ (YYYYMMDD)"
        required: false
        default: "20240101"
      csv_compress:
        description: "staging CSVをgzip圧縮する？ (true/false)"
        required: true
        default: "false"

concurrency:
  group: build-staging-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      SCOPE: ${{ inputs.scope }}
      DATE: ${{ inputs.date }}
      CSV_COMPRESS: ${{ inputs.csv_compress }}
      SHARDS_ROOT: data/shards
      RESULTS_ROOT: public/results
      OUT_ROOT: data/staging
      PY: scripts/build_staging_from_integrated.py

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install polars pandas pyyaml

      - name: Resolve paths
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p "$OUT_ROOT"

          if [[ "$SCOPE" == "day" ]]; then
            if [[ ! "$DATE" =~ ^[0-9]{8}$ ]]; then
              echo "DATE must be YYYYMMDD when scope=day (got: '$DATE')" >&2
              exit 1
            fi
            YEAR="${DATE:0:4}"
            MD="${DATE:4:4}"
            echo "YEAR=$YEAR" >> $GITHUB_ENV
            echo "MD=$MD" >> $GITHUB_ENV
            echo "IN_DIR=$SHARDS_ROOT/$YEAR/$MD" >> $GITHUB_ENV
            echo "OUT_DIR=$OUT_ROOT/$YEAR/$MD" >> $GITHUB_ENV
          else
            echo "YEAR=" >> $GITHUB_ENV
            echo "MD=" >> $GITHUB_ENV
            echo "IN_DIR=$SHARDS_ROOT" >> $GITHUB_ENV
            echo "OUT_DIR=$OUT_ROOT" >> $GITHUB_ENV
          fi

      - name: Build staging
        shell: bash
        run: |
          set -euo pipefail

          if [[ ! -f "$PY" ]]; then
            echo "[FATAL] $PY が見つかりません。リポジトリに追加してください。" >&2
            exit 1
          fi

          if [[ ! -d "$IN_DIR" ]]; then
            echo "[FATAL] Input directory not found: $IN_DIR" >&2
            echo "data/shards の生成がまだなら、先に shards を作ってください。" >&2
            exit 1
          fi

          ARGS=(--shards_root "$IN_DIR" --results_root "$RESULTS_ROOT" --out_root "$OUT_DIR" --out_format "csv")
          if [[ "${CSV_COMPRESS,,}" == "true" ]]; then
            ARGS+=("--csv_compress")
          fi

          echo "[run] python $PY ${ARGS[*]}"
          python "$PY" "${ARGS[@]}"

      - name: Show outputs
        run: |
          echo "---- $OUT_ROOT (tree) ----"
          ls -lahR "$OUT_ROOT" || true

      - name: Commit & push staging outputs
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add -f "$OUT_ROOT" || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          MSG_SCOPE="$SCOPE"
          MSG_DATE="${DATE:-'-'}"
          git commit -m "staging: build from data/shards ($MSG_SCOPE $MSG_DATE) [skip ci]"

          # 軽くリトライ付きでpush
          for n in 0 1 2 3 4; do
            if git pull --rebase --autostash; then
              if git push; then
                exit 0
              fi
            fi
            echo "Pull/Push failed. Retry $((n+1))/5..."
            sleep $((2**n))
          done

          git push
