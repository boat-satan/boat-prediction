name: Integrate Pro (daily shards)

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "開始日 (YYYYMMDD)"
        required: true
        default: "20240225"
      end_date:
        description: "終了日 (YYYYMMDD)"
        required: true
        default: "20240229"
      out_format:
        description: "出力形式 (csv / parquet / both)"
        required: true
        default: "parquet"
      csv_compress:
        description: "CSVをgzip圧縮（.csv.gz）する"
        required: true
        default: "false"

permissions:
  contents: write

concurrency:
  group: integrate-pro-${{ github.repository }}-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install polars pyarrow

      - name: Discover dates in range
        id: discover
        env:
          START: ${{ github.event.inputs.start_date }}
          END: ${{ github.event.inputs.end_date }}
        run: |
          set -euo pipefail
          mapfile -t ALL_DIRS < <(find public/programs/v1 -mindepth 2 -maxdepth 2 -type d 2>/dev/null | sort || true)
          DATES=()
          for d in "${ALL_DIRS[@]}"; do
            y=$(basename "$(dirname "$d")")
            md=$(basename "$d")
            [[ "$y" =~ ^[0-9]{4}$ && "$md" =~ ^[0-9]{4}$ ]] || continue
            hd="${y}${md}"
            if [[ "$hd" -ge "$START" && "$hd" -le "$END" ]]; then
              DATES+=("$hd")
            fi
          done
          if [ "${#DATES[@]}" -eq 0 ]; then
            echo "found_dates=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          uniq_sorted=$(printf "%s\n" "${DATES[@]}" | sort -u | tr '\n' ' ')
          echo "found_dates=${uniq_sorted}" >> "$GITHUB_OUTPUT"

      - name: Build daily shards (no global merge)
        if: steps.discover.outputs.found_dates != ''
        env:
          DATES: ${{ steps.discover.outputs.found_dates }}
          OUT_FMT: ${{ github.event.inputs.out_format }}
          CSV_COMPRESS: ${{ github.event.inputs.csv_compress }}
        run: |
          set -euo pipefail
          CSV_COMP_FLAG=""
          if [ "${CSV_COMPRESS,,}" = "true" ]; then
            CSV_COMP_FLAG="--csv_compress"
          fi
          for hd in ${DATES}; do
            YEAR="${hd:0:4}"
            MD="${hd:4:4}"
            PDIR="public/programs/v1/${YEAR}/${MD}"
            echo "===> Processing ${YEAR}/${MD}"
            python scripts/integrate_pro.py \
              --program_dir "${PDIR}" \
              --exhibition_dir public/exhibition/v1 \
              --results_dir public/results \
              --racer_dir public/racers-annual \
              --out_dir "data/shards" \
              --out_format "${OUT_FMT}" \
              ${CSV_COMP_FLAG}
          done

      - name: Commit & push shards
        if: steps.discover.outputs.found_dates != ''
        run: |
          set -euo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 60
          git config --global http.version HTTP/1.1

          git add -A data/shards || true
          if ! git diff --cached --quiet; then
            git commit -m "daily shards: ${{ github.event.inputs.start_date }}-${{ github.event.inputs.end_date }}"
            git push
          else
            echo "No changes to commit."
          fi

      - name: No dates
        if: steps.discover.outputs.found_dates == ''
        run: echo "No program dates in range."
